(function(e,t){typeof exports=="object"&&typeof require=="function"?module.exports=t(require("backbone")):typeof define=="function"&&define.amd?define(["backbone"],function(n){return t(n||e.Backbone)}):t(Backbone)})(this,function(e){function t(){return((1+Math.random())*65536|0).toString(16).substring(1)}function n(){return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function r(e){return e===Object(e)}function i(e,t){var n=e.length;while(n--)if(e[n]===t)return!0;return!1}function s(e,t){for(var n in t)e[n]=t[n];return e}function o(e,t){if(e==null)return void 0;var n=e[t];return typeof n=="function"?e[t]():n}return e.LocalStorage=window.Store=function(e,t){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=e,this.serializer=t||{serialize:function(e){return r(e)?JSON.stringify(e):e},deserialize:function(e){return e&&JSON.parse(e)}};var n=this.localStorage().getItem(this.name);this.records=n&&n.split(",")||[]},s(e.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return!e.id&&e.id!==0&&(e.id=n(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this._itemName(e.id),this.serializer.serialize(e)),this.records.push(e.id.toString()),this.save(),this.find(e)},update:function(e){this.localStorage().setItem(this._itemName(e.id),this.serializer.serialize(e));var t=e.id.toString();return i(this.records,t)||(this.records.push(t),this.save()),this.find(e)},find:function(e){return this.serializer.deserialize(this.localStorage().getItem(this._itemName(e.id)))},findAll:function(){var e=[];for(var t=0,n,r;t<this.records.length;t++)n=this.records[t],r=this.serializer.deserialize(this.localStorage().getItem(this._itemName(n))),r!=null&&e.push(r);return e},destroy:function(e){this.localStorage().removeItem(this._itemName(e.id));var t=e.id.toString();for(var n=0,r;n<this.records.length;n++)this.records[n]===t&&this.records.splice(n,1);return this.save(),e},localStorage:function(){return localStorage},_clear:function(){var e=this.localStorage(),t=new RegExp("^"+this.name+"-");e.removeItem(this.name);for(var n in e)t.test(n)&&e.removeItem(n);this.records.length=0},_storageSize:function(){return this.localStorage().length},_itemName:function(e){return this.name+"-"+e}}),e.LocalStorage.sync=window.Store.sync=e.localSync=function(t,n,r){var i=o(n,"localStorage")||o(n.collection,"localStorage"),s,u,f=e.$?e.$.Deferred&&e.$.Deferred():e.Deferred&&e.Deferred();try{switch(t){case"read":s=n.id!=undefined?i.find(n):i.findAll();break;case"create":s=i.create(n);break;case"update":s=i.update(n);break;case"delete":s=i.destroy(n)}}catch(l){l.code===22&&i._storageSize()===0?u="Private browsing is unsupported":u=l.message}return s?(r&&r.success&&(e.VERSION==="0.9.10"?r.success(n,s,r):r.success(s)),f&&f.resolve(s)):(u=u?u:"Record Not Found",r&&r.error&&(e.VERSION==="0.9.10"?r.error(n,u,r):r.error(u)),f&&f.reject(u)),r&&r.complete&&r.complete(s),f&&f.promise()},e.ajaxSync=e.sync,e.getSyncMethod=function(t,n){var r=n&&n.ajaxSync;return!r&&(o(t,"localStorage")||o(t.collection,"localStorage"))?e.localSync:e.ajaxSync},e.sync=function(t,n,r){return e.getSyncMethod(n,r).apply(this,[t,n,r])},e.LocalStorage});
// Copyright (c) 2011-2015 Thomas Pedersen

// Documentation and full license available at:

Backbone.Validation=function(e){"use strict";var t={forceUpdate:!1,selector:"name",labelFormatter:"sentenceCase",valid:Function.prototype,invalid:Function.prototype},n={formatLabel:function(e,n){return a[t.labelFormatter](e,n)},format:function(){var e=Array.prototype.slice.call(arguments),t=e.shift();return t.replace(/\{(\d+)\}/g,function(t,n){return"undefined"!=typeof e[n]?e[n]:t})}},r=function(t,n,i){return n=n||{},i=i||"",e.each(t,function(e,s){t.hasOwnProperty(s)&&(e&&"object"==typeof e&&e.constructor===Object&&r(e,n,i+s+"."),n[i+s]=e)}),n},i=function(){var i=function(t,n){return n=n||e.keys(e.result(t,"validation")||{}),e.reduce(n,function(e,t){return e[t]=void 0,e},{})},o=function(t,n){var r=t.attributes;return e.isFunction(r)?r=r(n):e.isString(r)&&e.isFunction(f[r])&&(r=f[r](n)),e.isArray(r)?r:void 0},u=function(t,n){var r=t.validation?e.result(t,"validation")[n]||{}:{};return(e.isFunction(r)||e.isString(r))&&(r={fn:r}),e.isArray(r)||(r=[r]),e.reduce(r,function(t,n){return e.each(e.without(e.keys(n),"msg"),function(e){t.push({fn:l[e],val:n[e],msg:n.msg})}),t},[])},a=function(t,r,i,s){return e.reduce(u(t,r),function(o,u){var a=e.extend({},n,l),f=u.fn.call(a,i,r,u.val,t,s);return f===!1||o===!1?!1:f&&!o?e.result(u,"msg")||f:o},"")},h=function(t,n,r){var i,s={},o=!0,u=e.clone(n);return e.each(r,function(e,n){i=a(t,n,e,u),i&&(s[n]=i,o=!1)}),{invalidAttrs:s,isValid:o}},p=function(t,n){return{preValidate:function(t,n){var r,i=this,s={};return e.isObject(t)?(e.each(t,function(e,t){r=i.preValidate(t,e),r&&(s[t]=r)}),e.isEmpty(s)?void 0:s):a(this,t,n,e.extend({},this.attributes))},isValid:function(i){var s,u,f,l;return i=i||o(n,t),e.isString(i)?u=[i]:e.isArray(i)&&(u=i),u&&(s=r(this.attributes),e.each(this.associatedViews,function(t){e.each(u,function(r){f=a(this,r,s[r],e.extend({},this.attributes)),f?(n.invalid(t,r,f,n.selector),l=l||{},l[r]=f):n.valid(t,r,n.selector)},this)},this)),i===!0&&(l=this.validate()),l&&this.trigger("invalid",this,l,{validationError:l}),u?!l:this.validation?this._isValid:!0},validate:function(s,u){var a=this,f=!s,l=e.extend({},n,u),p=i(a,o(n,t)),v=e.extend({},p,a.attributes,s),m=r(v),g=s?r(s):m,y=h(a,v,e.pick(m,e.keys(p)));return a._isValid=y.isValid,e.each(a.associatedViews,function(t){e.each(p,function(e,n){var r=y.invalidAttrs.hasOwnProperty(n),i=g.hasOwnProperty(n);r||l.valid(t,n,l.selector),r&&(i||f)&&l.invalid(t,n,y.invalidAttrs[n],l.selector)})}),e.defer(function(){a.trigger("validated",a._isValid,a,y.invalidAttrs),a.trigger("validated:"+(a._isValid?"valid":"invalid"),a,y.invalidAttrs)}),!l.forceUpdate&&e.intersection(e.keys(y.invalidAttrs),e.keys(g)).length>0?y.invalidAttrs:void 0}}},v=function(t,n,r){n.associatedViews?n.associatedViews.push(t):n.associatedViews=[t],e.extend(n,p(t,r))},m=function(t,n){n&&t.associatedViews.length>1?t.associatedViews=e.without(t.associatedViews,n):(delete t.validate,delete t.preValidate,delete t.isValid,delete t.associatedViews)},g=function(e){v(this.view,e,this.options)},y=function(e){m(e)};return{version:"0.11.3",configure:function(n){e.extend(t,n)},bind:function(n,r){r=e.extend({},t,s,r);var i=r.model||n.model,o=r.collection||n.collection;if("undefined"==typeof i&&"undefined"==typeof o)throw"Before you execute the binding your view must have a model or a collection.\nSee http://thedersen.com/projects/backbone-validation/#using-form-model-validation for more information.";i?v(n,i,r):o&&(o.each(function(e){v(n,e,r)}),o.bind("add",g,{view:n,options:r}),o.bind("remove",y))},unbind:function(t,n){n=e.extend({},n);var r=n.model||t.model,i=n.collection||t.collection;r?m(r,t):i&&(i.each(function(e){m(e,t)}),i.unbind("add",g),i.unbind("remove",y))},mixin:p(null,t)}}(),s=i.callbacks={valid:function(e,t,n){e.$("["+n+'~="'+t+'"]').removeClass("invalid").removeAttr("data-error")},invalid:function(e,t,n,r){e.$("["+r+'~="'+t+'"]').addClass("invalid").attr("data-error",n)}},o=i.patterns={digits:/^\d+$/,number:/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/,email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i,url:/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i},u=i.messages={required:"{0} is required",acceptance:"{0} must be accepted",min:"{0} must be greater than or equal to {1}",max:"{0} must be less than or equal to {1}",range:"{0} must be between {1} and {2}",length:"{0} must be {1} characters",minLength:"{0} must be at least {1} characters",maxLength:"{0} must be at most {1} characters",rangeLength:"{0} must be between {1} and {2} characters",oneOf:"{0} must be one of: {1}",equalTo:"{0} must be the same as {1}",digits:"{0} must only contain digits",number:"{0} must be a number",email:"{0} must be a valid email",url:"{0} must be a valid url",inlinePattern:"{0} is invalid"},a=i.labelFormatters={none:function(e){return e},sentenceCase:function(e){return e.replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0===t?e.toUpperCase():" "+e.toLowerCase()}).replace(/_/g," ")},label:function(e,t){return t.labels&&t.labels[e]||a.sentenceCase(e,t)}},f=i.attributeLoaders={inputNames:function(e){var t=[];return e&&e.$("form [name]").each(function(){/^(?:input|select|textarea)$/i.test(this.nodeName)&&this.name&&"submit"!==this.type&&-1===t.indexOf(this.name)&&t.push(this.name)}),t}},l=i.validators=function(){var t=String.prototype.trim?function(e){return null===e?"":String.prototype.trim.call(e)}:function(e){var t=/^\s+/,n=/\s+$/;return null===e?"":e.toString().replace(t,"").replace(n,"")},n=function(t){return e.isNumber(t)||e.isString(t)&&t.match(o.number)},r=function(n){return!(e.isNull(n)||e.isUndefined(n)||e.isString(n)&&""===t(n)||e.isArray(n)&&e.isEmpty(n))};return{fn:function(t,n,r,i,s){return e.isString(r)&&(r=i[r]),r.call(i,t,n,s)},required:function(t,n,i,s,o){var a=e.isFunction(i)?i.call(s,t,n,o):i;return a||r(t)?a&&!r(t)?this.format(u.required,this.formatLabel(n,s)):void 0:!1},acceptance:function(t,n,r,i){return"true"===t||e.isBoolean(t)&&t!==!1?void 0:this.format(u.acceptance,this.formatLabel(n,i))},min:function(e,t,r,i){return!n(e)||r>e?this.format(u.min,this.formatLabel(t,i),r):void 0},max:function(e,t,r,i){return!n(e)||e>r?this.format(u.max,this.formatLabel(t,i),r):void 0},range:function(e,t,r,i){return!n(e)||e<r[0]||e>r[1]?this.format(u.range,this.formatLabel(t,i),r[0],r[1]):void 0},length:function(t,n,r,i){return e.isString(t)&&t.length===r?void 0:this.format(u.length,this.formatLabel(n,i),r)},minLength:function(t,n,r,i){return!e.isString(t)||t.length<r?this.format(u.minLength,this.formatLabel(n,i),r):void 0},maxLength:function(t,n,r,i){return!e.isString(t)||t.length>r?this.format(u.maxLength,this.formatLabel(n,i),r):void 0},rangeLength:function(t,n,r,i){return!e.isString(t)||t.length<r[0]||t.length>r[1]?this.format(u.rangeLength,this.formatLabel(n,i),r[0],r[1]):void 0},oneOf:function(t,n,r,i){return e.include(r,t)?void 0:this.format(u.oneOf,this.formatLabel(n,i),r.join(", "))},equalTo:function(e,t,n,r,i){return e!==i[n]?this.format(u.equalTo,this.formatLabel(t,r),this.formatLabel(n,r)):void 0},pattern:function(e,t,n,i){return r(e)&&e.toString().match(o[n]||n)?void 0:this.format(u[n]||u.inlinePattern,this.formatLabel(t,i),n)}}}();return e.each(l,function(t,r){l[r]=e.bind(l[r],e.extend({},n,l))}),i}(_);